# 删除单条消息功能

## 功能概述

新增了选择性删除聊天记录的功能，允许用户删除特定的消息，而不是清空整个历史记录。

## 功能特性

### 1. 删除按钮
- 每条消息右上角都有删除按钮（鼠标悬停时显示）
- 点击删除按钮会弹出确认对话框
- 删除后会自动更新聊天记录

### 2. 消息显示
- 用户消息显示在右侧（粉色渐变背景）
- AI消息显示在左侧（白色背景，带花朵图标）
- 消息位置已修复，不再颠倒

### 3. 索引管理
- 前端和后端使用相同的消息索引
- 删除消息后索引会自动更新
- 支持历史记录加载时的索引重置

## API端点

### 删除指定索引的消息
```
DELETE /message/{message_index}
```

**响应示例：**
```json
{
  "success": true,
  "message": "已删除第 1 条消息",
  "deleted_message": {
    "role": "assistant",
    "content": "消息内容",
    "timestamp": 1754040205
  },
  "remaining_messages": 38
}
```

### 根据时间戳删除消息
```
DELETE /message/timestamp/{timestamp}
```

### 获取消息信息
```
GET /message/{message_index}
```

**响应示例：**
```json
{
  "success": true,
  "index": 0,
  "role": "assistant",
  "content": "消息内容",
  "timestamp": 1754040205,
  "has_audio": false,
  "audio_file": null,
  "audio_exists": false
}
```

## 使用方法

### 1. 前端删除
1. 将鼠标悬停在消息上
2. 点击右上角的红色删除按钮（×）
3. 确认删除操作
4. 消息会被删除，并显示确认消息

### 2. API删除
```bash
# 删除第0条消息
curl -X DELETE http://localhost:8000/message/0

# 删除时间戳为1754040205的消息
curl -X DELETE http://localhost:8000/message/timestamp/1754040205
```

## 注意事项

1. **索引范围**：删除前会检查索引是否在有效范围内
2. **音频文件**：删除AI消息时，对应的音频文件仍保留在output目录中
3. **历史记录**：删除操作会立即保存到聊天记录文件中
4. **确认对话框**：删除前会弹出确认对话框，防止误删

## 错误处理

- **索引超出范围**：返回错误信息，不执行删除
- **网络错误**：显示网络错误提示
- **服务器错误**：显示服务器错误信息

## 技术实现

### 前端
- 使用消息容器（message-container）包装每条消息
- 删除按钮只在鼠标悬停时显示
- 使用Map存储消息索引映射
- 支持历史记录加载时的索引重置

### 后端
- `delete_message_by_index()`: 根据索引删除消息
- `delete_message_by_timestamp()`: 根据时间戳删除消息
- `get_message_info()`: 获取消息详细信息
- 自动保存聊天记录到文件

## 测试

功能已通过以下测试：
- ✅ 消息显示位置正确（用户消息在右，AI消息在左）
- ✅ 删除按钮正常显示和隐藏
- ✅ 删除操作成功执行
- ✅ 索引范围检查正常
- ✅ 历史记录加载正常 